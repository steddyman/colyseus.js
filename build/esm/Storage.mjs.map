{"version":3,"file":"Storage.mjs","sources":["../../src/Storage.ts"],"sourcesContent":["/// <reference path=\"../typings/cocos-creator.d.ts\" />\n\n/**\n * We do not assign 'storage' to window.localStorage immediatelly for React\n * Native compatibility. window.localStorage is not present when this module is\n * loaded.\n */\n\nlet storage: any;\n\nfunction getStorage(): Storage {\n    if (!storage)  {\n        try {\n            storage = (typeof (cc) !== 'undefined' && cc.sys && cc.sys.localStorage)\n                ? cc.sys.localStorage  // compatibility with cocos creator\n                : window.localStorage; // RN does have window object at this point, but localStorage is not defined\n\n        } catch (e) {\n            // ignore error\n        }\n    }\n\n    if (!storage && typeof (globalThis.indexedDB) !== 'undefined') {\n        storage = new IndexedDBStorage();\n    }\n\n    if (!storage) {\n        // mock localStorage if not available (Node.js or RN environment)\n        storage = {\n            cache: {},\n            setItem: function (key, value) { this.cache[key] = value; },\n            getItem: function (key) { this.cache[key]; },\n            removeItem: function (key) { delete this.cache[key]; },\n        };\n    }\n\n    return storage;\n}\n\nexport function setItem(key: string, value: string) {\n    getStorage().setItem(key, value);\n}\n\nexport function removeItem(key: string) {\n    getStorage().removeItem(key);\n}\n\nexport function getItem(key: string, callback: Function) {\n    const value: any = getStorage().getItem(key);\n\n    if (\n        typeof (Promise) === 'undefined' || // old browsers\n        !(value instanceof Promise)\n    ) {\n        // browser has synchronous return\n        callback(value);\n\n    } else {\n        // react-native is asynchronous\n        value.then((id) => callback(id));\n    }\n}\n\n/**\n * When running in a Web Worker, we need to use IndexedDB to store data.\n */\nclass IndexedDBStorage {\n    private dbPromise: Promise<IDBDatabase> = new Promise((resolve) => {\n        const request = indexedDB.open('_colyseus_storage', 1);\n        request.onupgradeneeded = () => request.result.createObjectStore('store');\n        request.onsuccess = () => resolve(request.result);\n    });\n\n    private async tx(mode: IDBTransactionMode, fn: (store: IDBObjectStore) => IDBRequest) {\n        const db = await this.dbPromise;\n        const store = db.transaction('store', mode).objectStore('store');\n        return fn(store);\n    }\n\n    setItem(key: string, value: string) {\n        return this.tx('readwrite', store => store.put(value, key)).then();\n    }\n\n    async getItem(key: string) {\n        const request = await this.tx('readonly', store => store.get(key));\n        return new Promise<string | undefined>((resolve) => {\n            request.onsuccess = () => resolve(request.result);\n        });\n    }\n\n    removeItem(key: string) {\n        return this.tx('readwrite', store => store.delete(key)).then();\n    }\n}"],"names":[],"mappings":"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"}